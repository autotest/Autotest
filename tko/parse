#!/usr/bin/python
import os, re, parse, db, sys

if len(sys.argv) < 2:
	raise "I need a path to the results directory"

topdir = sys.argv[1]
jobs_list = os.listdir(topdir)

jobs = {}
db = db.db(autocommit=False)  # do commits transactionally

for j in jobs_list:
	print 'looking for ' + j
	if db.find_job(j):              # Job has already been parsed
		continue
	job = parse.job(os.path.join(topdir, j), 'regression')
	if not job:
		continue
	print 'parsed ' + j
	if not job.kernel:
		continue
	print '%s %s' % (j, job.kernel.base)
	for test in job.tests:
		print "\t%s %s %s" % (test.subdir, test.status, test.reason)
	db.insert_job(j, job)
	db.commit()

rows = db.select('distinct hostname', 'machines', {})
machines = [row[0] for row in rows]

for machine in machines:
	dir = os.path.dirname(os.path.abspath(sys.argv[0]))
	vertical_text = os.path.join(dir, 'vertical_text.py')
	os.system(vertical_text + ' ' + machine)

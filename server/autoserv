#!/usr/bin/python -u
#
# Copyright 2007 Google Inc. Released under the GPL v2

"""
Run an control file through the server side engine
"""

__author__ = """\
mbligh@google.com (Martin J. Bligh)
"""

import sys, os, re, server_job, hosts.site_host, utils

usage = """\
usage: autoserv
	[-m machine,[machine,...]] # list of machines to pass to control file
	[-c]                       # control file is a client side control
	[-r resultsdir]            # specify results directory (default '.')
	[-i]                       # reinstall machines before running the job
	[-I]                       # reinstall machines after running the job
	[-b]                       # reboot all specified machines after the job
	[-l label]                 # label for the job (arbitrary string)
	[-u user]                  # username for the job (email address)
	<control file>             # name of the control file to run
	[args ...]                 # args to pass through to the control file
"""

args = sys.argv[1:]
parser = utils.AutoservOptionParser(args)

machines = parser.parse_opts_param('-m', None, split = ',')
results  = parser.parse_opts_param('-r', os.path.abspath('.'))
label    = parser.parse_opts_param('-l', '')
user     = parser.parse_opts_param('-u', 'anonymous')
client   = parser.parse_opts('-c')
reboot   = parser.parse_opts('-b')
install_before = parser.parse_opts('-i')
install_after  = parser.parse_opts('-I')

if getattr(hosts.site_host, 'site_parse_options', None):
	hosts.site_host.site_parse_options(parser)

if len(parser.args) < 1:
	print usage
	sys.exit(-1)

job = server_job.server_job(parser.args[0], parser.args[1:], results, label,
								user, client)
job.run(machines, reboot, install_before, install_after)

AUTHOR = "mbligh@google.com (Martin Bligh)"
TIME = "SHORT"
NAME = "Netperf Multi-machine"
TEST_CATEGORY = "Stress"
TEST_TYPE = "Server"
SYNC_COUNT = 2
DOC = """
netperf_test is a 2 machine test (server/client) that analyzes qos and returns
the results.

The default test takes roughly 10 minutes to run.  The arguments that can be
passed into the job.run_test are:

time_limit       default 600 seconds
bandwidth_min    default 1000 mbit
bandwidth_max    default 1000 mbit
priority         default 2
container_name   default "/"
"""

from autotest_lib.server import utils


def run(pair):
    print "running on %s and %s\n" % (pair[0], pair[1])
    server = hosts.create_host(pair[0])
    client = hosts.create_host(pair[1])

    server_at = autotest.Autotest(server)
    client_at = autotest.Autotest(client)

    template = ''.join(["job.run_test('netperf2', server_ip='%s', client_ip=",
                        "'%s', role='%s', test_time=10,",
                        "stream_list=range(1,6,2))"])

    server_control_file = template % (server.ip, client.ip, 'server')
    client_control_file = template % (server.ip, client.ip, 'client')

    server_command = subcommand(server_at.run,
                                [server_control_file, server.hostname])
    client_command = subcommand(client_at.run,
                                [client_control_file, client.hostname])

    parallel([server_command, client_command])


# grab the pairs (and failures)
(pairs, failures) = utils.form_ntuples_from_machines(machines, 2)

# log the failures
for failure in failures:
    job.record("FAIL", failure[0], "netperf2", failure[1])

# now run through each pair and run
parallel_simple(run, pairs)
